type: "remap"
inputs:
  - _SYSTEM_filebeat
source: |
  if .fields.os_family == "redhat" {
    .app, err = parse_regex(.log.file.path, r'^/home/Falcon/logs/falcon-(?P<app>[^/]+)/').app ??
                parse_regex(.log.file.path, r'^/data/dwc/app/.+-(?P<core>[^/]+)-(?P<app>[^/]+)/').app ??
                parse_regex(.log.file.path, r'^/data/dwyb/app/.+-(?P<core>[^/]+)-(?P<app>[^/]+)/').app ??
                parse_regex(.log.file.path, r'^/home/svc_dwclob/dwclob/(?P<app>[^/]+)/').app ??
                parse_regex(.log.file.path, r'^/data/dwc/(?P<app>[^/]+)/').app ??
                parse_regex(.log.file.path, r'^/data/dwyb/(?P<app>[^/]+)/').app
  }
  if .fields.os_family == "windows" {
    .app = parse_regex!(.log.file.path, r'^d:\\localhost\\log\\(?P<app>.+?)(\.\d{8})?\.err').app
  }
  .app = downcase!(.app)

  .parse, err = parse_regex(.message, r'(?P<log_level>\w+)\s+(?P<event_timestamp>\d{2}/\d{2} \d{2}:\d{2}:\d{2}\.\d{3})') ??
                parse_regex(.message, r'(?P<event_timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})[0-9]{3}: (?P<log_level>\w+)') ??
                parse_regex(.message, r'(?P<event_timestamp>\d{8}-\d{2}:\d{2}:\d{2}\.\d{3})') ??
                parse_regex(.message, r'(?P<log_level>\w+)\s+(?P<event_timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{6}Z)')
  .event_timestamp = .parse.event_timestamp
  .log_level = .parse.log_level
  del(.parse)

  if is_null(.fields.env) {
    .fields.env = "missing"
    .fields.error_info = "fields.env missing"
  }

  if is_null(.fields.region) {
    .fields.region = "missing"
    .fields.error_info = "fields.region missing"
  }

  if is_null(.app) {
    .app = "missing"
    .fields.error_info = "app field missing"
  }

  if .fields.app_group == "systemtester" {
    .fields.subsystemName = .fields.app_group
  } else if .fields.app_group == "dwclob" {
    .fields.subsystemName = "dwc-" + .app
  } else if .fields.app_group == "dwyb" {
    .fields.subsystemName = "dwyb-" + .app
  } else {
    .fields.subsystemName = "dw-" + .app
  }
